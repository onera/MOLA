#    Copyright 2023 ONERA - contact luis.bernardos@onera.fr
#
#    This file is part of MOLA.
#
#    MOLA is free software: you can redistribute it and/or modify
#    it under the terms of the GNU Lesser General Public License as published by
#    the Free Software Foundation, either version 3 of the License, or
#    (at your option) any later version.
#
#    MOLA is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU Lesser General Public License for more details.
#
#    You should have received a copy of the GNU Lesser General Public License
#    along with MOLA.  If not, see <http://www.gnu.org/licenses/>.

'''
MOLA - Visu.py

VISU MODULE

Collection of routines and functions designed for visualization
techniques.

USEFUL NOTES:

Command lines for animations:

# first, resize your images to the width size desired for final video (e.g. 600 px)
cd FRAMES
for img in frame*.png; do convert -resize 600 -quality 100 "$img" "resized-$img"; done

# second, create movie with (increase fps for having faster motion)
mencoder  mf://FRAMES/resized-frame*.png -mf fps=24  -ovc x264 -x264encopts subq=6:partitions=all:8x8dct:me=umh:frameref=5:bframes=3:b_pyramid=normal:weight_b -o movie.avi

# then convert movie to gif, by scaling to desired pixels (e.g. width 400 px)
ffmpeg -i movie.avi -vf "fps=10,scale=400:-1:flags=lanczos,split[s0][s1];[s0]palettegen[p];[s1][p]paletteuse" -loop 0 animation.gif

File history:
12/06/2020 - v1.8.01 - L. Bernardos - Creation
'''

import MOLA
from . import InternalShortcuts as J

if not MOLA.__ONLY_DOC__:
    import sys
    import os
    import numpy as np
    from time import sleep

    import matplotlib.pyplot as plt
    import matplotlib.colors as mplcolors
    from matplotlib import cm
    from matplotlib.colors import ListedColormap, LinearSegmentedColormap
    from matplotlib.backends.backend_pdf import PdfPages


    import Converter.PyTree as C
    import Converter.Internal as I
    import Transform.PyTree as T
    import Post.PyTree as P

def exit(): os._exit(0)

class Figure():

    def __init__(self, window_in_pixels=(1200,800), dpi=100, camera={}, filename=None, Elements=[]):
        self.window_in_pixels = window_in_pixels
        self.dpi = dpi
        self.camera = camera
        self.filename = filename
        self.Elements = Elements
        self.arrays = None
        
        self.fig = None

    def plotSurfaces(self, surfaces, filename=None, Elements=None,
            default_vertex_container='FlowSolution#InitV',
            default_centers_container='BCDataSet'):
        
        if filename:
            self.filename = filename
            self.fig = None  # init fig to call createOverlap next time
        if Elements is not None:
            self.Elements = Elements

        machine = os.getenv('MAC')
        external_centers_container = I.__FlowSolutionCenters__
        external_vertex_container = I.__FlowSolutionNodes__

        # TODO solve bugs:
        # https://elsa.onera.fr/issues/10536
        # https://elsa.onera.fr/issues/11045

        offscreen_mode = 'mesa'

        if offscreen_mode == 'auto':
            import CPlot.PyTree as CPlot
            if machine in ['sator']:
                offscreen=5 # MESA 
            elif machine in ['ld','visung', 'visio', 'sator', 'spiro']:
                offscreen=3 # openGL
            else:
                raise SystemError('machine "%s" not supported.'%machine)
        elif offscreen_mode == 'mesa':
            try: import CPlotOffscreen.PyTree as CPlot
            except: import CPlot.PyTree as CPlot
            offscreen=5 # MESA 
        else:
            raise SystemError('offscreen_mode "%s" not supported.'%offscreen_mode)


        cmap2int = dict(Blue2Red=1, Diverging=15, Black2White=15,
                        Viridis=17, Inferno=19, Magma=21, Plasma=23, Jet=25,
                        Greys=27, NiceBlue=29, Greens=31)

        if isinstance(surfaces,str):
            t = C.convertFile2PyTree(surfaces)
        elif I.isTopTree(surfaces):
            t = surfaces
        else:
            raise ValueError('parameter mesh must be either a filename or a PyTree')

        DIRECTORY_FRAMES = self.filename.split(os.path.sep)[:-1]    
        try: os.makedirs(os.path.join(*DIRECTORY_FRAMES))
        except: pass

        DisplayOptions = dict(mode='Render', displayInfo=0, displayIsoLegend=0, 
                            win=self.window_in_pixels, export=self.filename, shadow=1,
                            exportResolution='%gx%g'%self.window_in_pixels)
        DisplayOptions.update(self.camera)

        def hasBlending(elt):
            try: return elt['blending'] < 1
            except: return False

        Trees = []
        TreesBlending = []
        for i, elt in enumerate(self.Elements):
            try: selection = elt['selection']
            except KeyError: selection = {}
            try: blending = elt['blending']
            except KeyError: blending = 1
            try: material = elt['material']
            except KeyError: material = 'Solid'
            try: color = elt['color']
            except KeyError: color = elt['color'] = 'White'
            try: vertex_container = elt['vertex_container']
            except KeyError: vertex_container = default_vertex_container
            try: centers_container = elt['centers_container']
            except KeyError: centers_container = default_centers_container
            I.__FlowSolutionNodes__ = vertex_container
            I.__FlowSolutionCenters__ = centers_container
            elt.setdefault('iso_line', [])
            if not isinstance(elt['iso_line'], (list, np.ndarray)):
                elt['iso_line'] = [elt['iso_line']]
            elt.setdefault('iso_line_color', 'Black')

            field_name = elt['color'].replace('Iso:','')
            if elt['color'].startswith('Iso:'):
                zones = [z for z in J.selectZones(t, **selection) if 
                    _fieldExistsAtNodesOrCentersAtZone(z, field_name,
                        vertex_container, centers_container)]
                if not zones:
                    print(J.WARN+f'WARNING: visualization element [{i}]:')
                    print(f'field "{field_name}" does not exist in container {vertex_container} nor {centers_container} of any selected zones')
                    print('please adjust the vertex_container and centers_container options'+J.ENDC)
                    continue
            else:
                zones = J.selectZones(t, **selection)

            if hasBlending(elt): zones = C.convertArray2Hexa(zones) # see cassiopee #8740            

            for z in zones:
                CPlot._addRender2Zone(z, material=material,color=color, blending=blending)
            
            # Add iso lines if required
            for value in elt['iso_line']: 
                isoLine = P.isoLine(zones, field_name, value)
                CPlot._addRender2Zone(isoLine, material='Solid', color=elt['iso_line_color'])
                zones.append(isoLine)

            if hasBlending(elt):
                TreesBlending += [ C.newPyTree(['blend.%d'%i, zones]) ]
            else:
                Trees += [ C.newPyTree(['elt.%d'%i, zones]) ]

        # requires to append blended zones (see cassiopee #8740 and #8748)
        if TreesBlending:
            for i in range(len(Trees)):
                Trees[i] = I.merge([Trees[i]]+TreesBlending)
        
        for i in range(len(Trees)):
            tree = Trees[i]
            elt = self.Elements[i]

            try: vertex_container = elt['vertex_container']
            except KeyError: vertex_container = default_vertex_container
            try: centers_container = elt['centers_container']
            except KeyError: centers_container = default_centers_container
            I.__FlowSolutionNodes__ = vertex_container
            I.__FlowSolutionCenters__ = centers_container


            if elt['color'].startswith('Iso:'):
                field_name = elt['color'].replace('Iso:','')

                if 'levels' not in elt: levels=[200,'min','max']
                else: levels = elt['levels']

                levels[1] = _getMin(tree, field_name) if levels[1] == 'min' else float(levels[1])
                levels[2] = _getMax(tree, field_name) if levels[2] == 'max' else float(levels[2])
                elt['levels'] = levels
                isoScales = [[field_name, levels[0], levels[1], levels[2]],
                ['centers:'+field_name, levels[0], levels[1], levels[2]]]
            else:
                isoScales = []

            increment_offscreen = len(Trees)==1 or (i>0 and i == len(Trees)-1 and offscreen > 1)
            if increment_offscreen: offscreen += 1

            try: additionalDisplayOptions = elt['additionalDisplayOptions']
            except: additionalDisplayOptions = {}

            try: additionalStateOptions = elt['additionalStateOptions']
            except: additionalStateOptions = {}

            if  'backgroundFile' not in additionalDisplayOptions and \
                'bgColor' not in additionalDisplayOptions:
                MOLA = os.getenv('MOLA')
                MOLASATOR = os.getenv('MOLASATOR')
                for MOLAloc in [MOLA, MOLASATOR]:
                    backgroundFile = os.path.join(MOLAloc,'MOLA','GUIs','background.png')
                    if os.path.exists(backgroundFile):
                        CPlot.setState(backgroundFile=backgroundFile)
                        CPlot.setState(bgColor=13)
                        break
            if additionalStateOptions: CPlot.setState(**additionalStateOptions)


            try: cmap = cmap2int[elt['colormap']]
            except KeyError: cmap=0
            try:
                if 'shadow' not in elt: elt['shadow'] = True
                if not elt['shadow']: cmap -= 1
            except: pass

            CPlot.display(tree, offscreen=offscreen, colormap=cmap,
                isoScales=isoScales, **DisplayOptions, **additionalDisplayOptions)
            if offscreen_mode == 'mesa':
                if not increment_offscreen:
                    CPlot.finalizeExport(offscreen)
            else:
                CPlot.finalizeExport(offscreen)
        
        I.__FlowSolutionCenters__ = external_centers_container
        I.__FlowSolutionNodes__ = external_vertex_container

    def createOverlap(self):
        img = plt.imread(self.filename)

        fig, ax = plt.subplots(figsize=(img.shape[1]/float(self.dpi),
                                         img.shape[0]/float(self.dpi)), dpi=self.dpi)

        self.fig = fig
        self.axes = [ax]
        
        self._buildCPlotColormaps()

        ax.imshow(img)
        ax.plot([],[])
        ax.set_axis_off()
        plt.subplots_adjust(left=0., bottom=0., right=1., top=1., wspace=0., hspace=0.)
        return img

    def _buildCPlotColormaps(self):
        f = [0,0.03125,0.0625,0.09375, 0.125, 0.15625, 0.1875, 0.21875, 0.25,
            0.28125, 0.3125, 0.34375, 0.375, 0.40625, 0.4375, 0.46875, 0.50,
            0.53125, 0.5625, 0.59375, 0.625, 0.65625, 0.6875, 0.71875, 0.75,
            0.78125, 0.8125, 0.84375, 0.875, 0.900625, 0.9375, 0.96875, 1.0]

        # keys must be the same as available in plotSurfaces
        self.color_codes = dict(
            Blue2Red=[(0.00,[0,0,1]),
                      (0.25,[0,1,1]),
                      (0.50,[0,1,0]),
                      (0.75,[1,1,0]),
                      (1.00,[1,0,0])],
            Diverging=[(f[0], [0.23137254902, 0.298039215686,0.752941176471]),
                       (f[1], [0.23137254902+1.12941176471*f[1],0.298039215686+1.7568627451*f[1],0.7980392156854992]),
                       (f[2], [0.23137254902+1.12941176471*f[2],0.298039215686+1.7568627451*f[2],15.6588235294-237.050980392*f[2]]),
                       (f[3], [0.223529411765+1.25490196078*f[3], 0.305882352941+1.63137254902*f[3],  0.764705882353+1.25490196078*f[3]]),
                       (f[4], [0.211764705882+1.38039215686*f[4], 0.305882352941+1.63137254902*f[4],  0.776470588235+1.12941176471*f[4]]),
                       (f[5], [0.227450980392+1.25490196078*f[5], 0.321568627451+1.50588235294*f[5], 0.807843137255+0.878431372549*f[5]]),
                       (f[6], [0.207843137255+1.38039215686*f[6], 0.321568627451+1.50588235294*f[6], 0.827450980392+0.752941176471*f[6]]),
                       (f[7], [0.207843137255+1.38039215686*f[7], 0.345098039216+1.38039215686*f[7], 0.874509803922+0.501960784314*f[7]]),
                       (f[8], [0.207843137255+1.38039215686*f[8], 0.345098039216+1.38039215686*f[8], 0.901960784314+0.376470588235*f[8]]),
                       (f[9], [0.207843137255+1.38039215686*f[9], 0.407843137255+1.12941176471*f[9], 0.964705882353+0.125490196078*f[9]]),
                       (f[10],[0.207843137255+1.38039215686*f[10],0.407843137255+1.12941176471*f[10],1.0]),
                       (f[11],[0.207843137255+1.38039215686*f[11], 0.486274509804+0.878431372549*f[11], 1.07843137255-0.250980392157*f[11]]),
                       (f[12],[0.250980392157+1.25490196078*f[12], 0.486274509804+0.878431372549*f[12], 1.16470588235-0.501960784314*f[12]]),
                       (f[13],[0.250980392157+1.25490196078*f[13], 0.580392156863+0.627450980392*f[13], 1.21176470588-0.627450980392*f[13]]),
                       (f[14],[0.250980392157+1.25490196078*f[14],  0.63137254902+0.501960784314*f[14], 1.26274509804-0.752941176471*f[14]]),
                       (f[15],[0.305882352941+1.12941176471*f[15], 0.741176470588+0.250980392157*f[15],  1.37254901961-1.00392156863*f[15]]),
                       (f[16],[0.364705882353+1.00392156863*f[16], 0.858823529412, 1.43137254902-1.12941176471*f[16]  ]),
                       (f[17],[0.364705882353+1.00392156863*f[17],0.733333333333+0.250980392157*f[17],1.61960784314-1.50588235294*f[17]]),
                       (f[18],[0.43137254902+0.878431372549*f[18], 1.2-0.627450980392*f[18], 1.61960784314-1.50588235294*f[18]]),
                       (f[19],[0.572549019608+0.627450980392*f[19],1.2-0.627450980392*f[19],1.61960784314-1.50588235294*f[19]]),
                       (f[20],[0.647058823529+0.501960784314*f[20], 1.34901960784-0.878431372549*f[20], 1.61960784314-1.50588235294*f[20]]),
                       (f[21],[0.803921568627+0.250980392157*f[21], 1.42745098039-1.00392156863*f[21], 1.69803921569-1.63137254902*f[21]]),
                       (f[22],[0.96862745098, 1.50980392157-1.12941176471*f[22], 1.61568627451-1.50588235294*f[22]]),
                       (f[23],[0.96862745098, 1.59607843137-1.25490196078*f[23], 1.70196078431-1.63137254902*f[23]]),
                       (f[24],[1.23921568627-0.376470588235*f[24], 1.6862745098-1.38039215686*f[24], 1.61176470588-1.50588235294*f[24]]),
                       (f[25],[1.23921568627-0.376470588235*f[25],1.78039215686-1.50588235294*f[25],1.61176470588-1.50588235294*f[25]]),
                       (f[26],[1.43529411765-0.627450980392*f[26], 1.87843137255-1.63137254902*f[26], 1.61176470588-1.50588235294*f[26]]),
                       (f[27],[1.63921568627-0.878431372549*f[27],1.98039215686-1.7568627451*f[27],1.50980392157-1.38039215686*f[27]]),
                       (f[28],[1.63921568627-0.878431372549*f[28], 2.0862745098-1.88235294118*f[28], 1.50980392157-1.38039215686*f[28]]),
                       (f[29],[1.85882352941-1.12941176471*f[29],2.19607843137-2.00784313725*f[29],1.50980392157-1.38039215686*f[29]]),
                       (f[30],[1.97254901961-1.25490196078*f[30], 4.2431372549-4.26666666667*f[30], 1.39607843137-1.25490196078*f[30]]),
                       (f[31],[2.09019607843-1.38039215686*f[31], 2.83137254902-2.76078431373*f[31], 1.27843137255-1.12941176471*f[31]]),
                       (f[32],[2.21176470588-1.50588235294*f[32], 4.53333333333-4.51764705882*f[32], 1.27843137255-1.12941176471*f[32]])],
            Black2White=[(0.00,[0.,0.,0.]),
                         (1.00,[1.,1.,1.])],
            Viridis=[ (0.        , [0.267004, 0.004874, 0.329415]),
                      (0.01010101, [0.269944, 0.014625, 0.341379]),
                      (0.02020202, [0.273809, 0.031497, 0.358853]),
                      (0.03030303, [0.276022, 0.044167, 0.370164]),
                      (0.04040404, [0.278791, 0.062145, 0.386592]),
                      (0.05050505, [0.280267, 0.073417, 0.397163]),
                      (0.06060606, [0.281924, 0.089666, 0.412415]),
                      (0.07070707, [0.282910, 0.105393, 0.426902]),
                      (0.08080808, [0.283197, 0.115680, 0.436115]),
                      (0.09090909, [0.283072, 0.130895, 0.449241]),
                      (0.1010101 , [0.282623, 0.140926, 0.457517]),
                      (0.11111111, [0.281412, 0.155834, 0.469201]),
                      (0.12121212, [0.279574, 0.170599, 0.479997]),
                      (0.13131313, [0.278012, 0.180367, 0.486697]),
                      (0.14141414, [0.275191, 0.194905, 0.496005]),
                      (0.15151515, [0.273006, 0.204520, 0.501721]),
                      (0.16161616, [0.269308, 0.218818, 0.509577]),
                      (0.17171717, [0.266580, 0.228262, 0.514349]),
                      (0.18181818, [0.262138, 0.242286, 0.520837]),
                      (0.19191919, [0.257322, 0.256130, 0.526563]),
                      (0.2020202 , [0.253935, 0.265254, 0.529983]),
                      (0.21212121, [0.248629, 0.278775, 0.534556]),
                      (0.22222222, [0.244972, 0.287675, 0.537260]),
                      (0.23232323, [0.239346, 0.300855, 0.540844]),
                      (0.24242424, [0.233603, 0.313828, 0.543914]),
                      (0.25252525, [0.229739, 0.322361, 0.545706]),
                      (0.26262626, [0.223925, 0.334994, 0.548053]),
                      (0.27272727, [0.220057, 0.343307, 0.549413]),
                      (0.28282828, [0.214298, 0.355619, 0.551184]),
                      (0.29292929, [0.210503, 0.363727, 0.552206]),
                      (0.3030303 , [0.204903, 0.375746, 0.553533]),
                      (0.31313131, [0.199430, 0.387607, 0.554642]),
                      (0.32323232, [0.195860, 0.395433, 0.555276]),
                      (0.33333333, [0.190631, 0.407061, 0.556089]),
                      (0.34343434, [0.187231, 0.414746, 0.556547]),
                      (0.35353535, [0.182256, 0.426184, 0.557120]),
                      (0.36363636, [0.177423, 0.437527, 0.557565]),
                      (0.37373737, [0.174274, 0.445044, 0.557792]),
                      (0.38383838, [0.169646, 0.456262, 0.558030]),
                      (0.39393939, [0.166617, 0.463708, 0.558119]),
                      (0.4040404 , [0.162142, 0.474838, 0.558140]),
                      (0.41414141, [0.157729, 0.485932, 0.558013]),
                      (0.42424242, [0.154815, 0.493313, 0.557840]),
                      (0.43434343, [0.150476, 0.504369, 0.557430]),
                      (0.44444444, [0.147607, 0.511733, 0.557049]),
                      (0.45454545, [0.143343, 0.522773, 0.556295]),
                      (0.46464646, [0.140536, 0.530132, 0.555659]),
                      (0.47474747, [0.136408, 0.541173, 0.554483]),
                      (0.48484848, [0.132444, 0.552216, 0.553018]),
                      (0.49494949, [0.129933, 0.559582, 0.551864]),
                      (0.50505051, [0.126453, 0.570633, 0.549841]),
                      (0.51515152, [0.124395, 0.578002, 0.548287]),
                      (0.52525253, [0.121831, 0.589055, 0.545623]),
                      (0.53535354, [0.120092, 0.600104, 0.542530]),
                      (0.54545455, [0.119512, 0.607464, 0.540218]),
                      (0.55555556, [0.119699, 0.618490, 0.536347]),
                      (0.56565657, [0.120638, 0.625828, 0.533488]),
                      (0.57575758, [0.123444, 0.636809, 0.528763]),
                      (0.58585859, [0.126326, 0.644107, 0.525311]),
                      (0.5959596 , [0.132268, 0.655014, 0.519661]),
                      (0.60606061, [0.140210, 0.665859, 0.513427]),
                      (0.61616162, [0.146616, 0.673050, 0.508936]),
                      (0.62626263, [0.157851, 0.683765, 0.501686]),
                      (0.63636364, [0.166383, 0.690856, 0.496502]),
                      (0.64646465, [0.180653, 0.701402, 0.488189]),
                      (0.65656566, [0.196571, 0.711827, 0.479221]),
                      (0.66666667, [0.208030, 0.718701, 0.472873]),
                      (0.67676768, [0.226397, 0.728888, 0.462789]),
                      (0.68686869, [0.239374, 0.735588, 0.455688]),
                      (0.6969697 , [0.259857, 0.745492, 0.444467]),
                      (0.70707071, [0.281477, 0.755203, 0.432552]),
                      (0.71717172, [0.296479, 0.761561, 0.424223]),
                      (0.72727273, [0.319809, 0.770914, 0.411152]),
                      (0.73737374, [0.335885, 0.777018, 0.402049]),
                      (0.74747475, [0.360741, 0.785964, 0.387814]),
                      (0.75757576, [0.377779, 0.791781, 0.377939]),
                      (0.76767677, [0.404001, 0.800275, 0.362552]),
                      (0.77777778, [0.430983, 0.808473, 0.346476]),
                      (0.78787879, [0.449368, 0.813768, 0.335384]),
                      (0.7979798 , [0.477504, 0.821444, 0.318195]),
                      (0.80808081, [0.496615, 0.826376, 0.306377]),
                      (0.81818182, [0.525776, 0.833491, 0.288127]),
                      (0.82828283, [0.555484, 0.840254, 0.269281]),
                      (0.83838384, [0.575563, 0.844566, 0.256415]),
                      (0.84848485, [0.606045, 0.850733, 0.236712]),
                      (0.85858586, [0.626579, 0.854645, 0.223353]),
                      (0.86868687, [0.657642, 0.860219, 0.203082]),
                      (0.87878788, [0.678489, 0.863742, 0.189503]),
                      (0.88888889, [0.709898, 0.868751, 0.169257]),
                      (0.8989899 , [0.741388, 0.873449, 0.149561]),
                      (0.90909091, [0.762373, 0.876424, 0.137064]),
                      (0.91919192, [0.793760, 0.880678, 0.120005]),
                      (0.92929293, [0.814576, 0.883393, 0.110347]),
                      (0.93939394, [0.845561, 0.887322, 0.099702]),
                      (0.94949495, [0.876168, 0.891125, 0.095250]),
                      (0.95959596, [0.896320, 0.893616, 0.096335]),
                      (0.96969697, [0.926106, 0.897330, 0.104071]),
                      (0.97979798, [0.945636, 0.899815, 0.112838]),
                      (0.98989899, [0.974417, 0.903590, 0.130215]),
                      (1.        , [0.993248, 0.906157, 0.143936])],
            Inferno=[ (0.        , [0.001462, 0.000466, 0.013866]),
                        (0.01010101, [0.003299, 0.002249, 0.024239]),
                        (0.02020202, [0.007676, 0.006136, 0.046836]),
                        (0.03030303, [0.011663, 0.009417, 0.063460]),
                        (0.04040404, [0.019373, 0.015133, 0.088767]),
                        (0.05050505, [0.025793, 0.019331, 0.105930]),
                        (0.06060606, [0.037668, 0.025921, 0.132232]),
                        (0.07070707, [0.051644, 0.032474, 0.159254]),
                        (0.08080808, [0.061340, 0.036590, 0.177642]),
                        (0.09090909, [0.076637, 0.041905, 0.205799]),
                        (0.1010101 , [0.087411, 0.044556, 0.224813]),
                        (0.11111111, [0.104551, 0.047008, 0.253430]),
                        (0.12121212, [0.122908, 0.047536, 0.281624]),
                        (0.13131313, [0.135778, 0.046856, 0.299776]),
                        (0.14141414, [0.155850, 0.044559, 0.325338]),
                        (0.15151515, [0.169575, 0.042489, 0.340874]),
                        (0.16161616, [0.190367, 0.039309, 0.361447]),
                        (0.17171717, [0.204209, 0.037632, 0.373238]),
                        (0.18181818, [0.224763, 0.036405, 0.388129]),
                        (0.19191919, [0.244967, 0.037055, 0.400007]),
                        (0.2020202 , [0.258234, 0.038571, 0.406485]),
                        (0.21212121, [0.277850, 0.042353, 0.414392]),
                        (0.22222222, [0.290763, 0.045644, 0.418637]),
                        (0.23232323, [0.309935, 0.051407, 0.423721]),
                        (0.24242424, [0.328921, 0.057827, 0.427511]),
                        (0.25252525, [0.341500, 0.062325, 0.429425]),
                        (0.26262626, [0.360284, 0.069247, 0.431497]),
                        (0.27272727, [0.372768, 0.073915, 0.432400]),
                        (0.28282828, [0.391453, 0.080927, 0.433109]),
                        (0.29292929, [0.403894, 0.085580, 0.433179]),
                        (0.3030303 , [0.422549, 0.092501, 0.432714]),
                        (0.31313131, [0.441207, 0.099338, 0.431594]),
                        (0.32323232, [0.453651, 0.103848, 0.430498]),
                        (0.33333333, [0.472328, 0.110547, 0.428334]),
                        (0.34343434, [0.484789, 0.114974, 0.426548]),
                        (0.35353535, [0.503493, 0.121575, 0.423356]),
                        (0.36363636, [0.522206, 0.128150, 0.419549]),
                        (0.37373737, [0.534683, 0.132534, 0.416667]),
                        (0.38383838, [0.553392, 0.139134, 0.411829]),
                        (0.39393939, [0.565854, 0.143567, 0.408258]),
                        (0.4040404 , [0.584521, 0.150294, 0.402385]),
                        (0.41414141, [0.603139, 0.157151, 0.395891]),
                        (0.42424242, [0.615513, 0.161817, 0.391219]),
                        (0.43434343, [0.633998, 0.168992, 0.383704]),
                        (0.44444444, [0.646260, 0.173914, 0.378359]),
                        (0.45454545, [0.664540, 0.181539, 0.369846]),
                        (0.46464646, [0.676638, 0.186807, 0.363849]),
                        (0.47474747, [0.694627, 0.195021, 0.354388]),
                        (0.48484848, [0.712396, 0.203656, 0.344383]),
                        (0.49494949, [0.724103, 0.209670, 0.337424]),
                        (0.50505051, [0.741423, 0.219112, 0.326576]),
                        (0.51515152, [0.752794, 0.225706, 0.319085]),
                        (0.52525253, [0.769556, 0.236077, 0.307485]),
                        (0.53535354, [0.785929, 0.247056, 0.295477]),
                        (0.54545455, [0.796607, 0.254728, 0.287264]),
                        (0.55555556, [0.812239, 0.266786, 0.274661]),
                        (0.56565657, [0.822386, 0.275197, 0.266085]),
                        (0.57575758, [0.837165, 0.288385, 0.252988]),
                        (0.58585859, [0.846709, 0.297559, 0.244113]),
                        (0.5959596 , [0.860533, 0.311892, 0.230606]),
                        (0.60606061, [0.873741, 0.326906, 0.216886]),
                        (0.61616162, [0.882188, 0.337287, 0.207628]),
                        (0.62626263, [0.894305, 0.353399, 0.193584]),
                        (0.63636364, [0.902003, 0.364492, 0.184116]),
                        (0.64646465, [0.912966, 0.381636, 0.169755]),
                        (0.65656566, [0.923215, 0.399359, 0.155193]),
                        (0.66666667, [0.929644, 0.411479, 0.145367]),
                        (0.67676768, [0.938675, 0.430091, 0.130438]),
                        (0.68686869, [0.944285, 0.442772, 0.120354]),
                        (0.6969697 , [0.952075, 0.462178, 0.105031]),
                        (0.70707071, [0.959114, 0.482014, 0.089499]),
                        (0.71717172, [0.963387, 0.495462, 0.079073]),
                        (0.72727273, [0.969163, 0.515946, 0.063488]),
                        (0.73737374, [0.972590, 0.529798, 0.053324]),
                        (0.74747475, [0.977092, 0.550850, 0.039050]),
                        (0.75757576, [0.979666, 0.565057, 0.031409]),
                        (0.76767677, [0.982881, 0.586606, 0.024661]),
                        (0.77777778, [0.985315, 0.608422, 0.024202]),
                        (0.78787879, [0.986502, 0.623105, 0.027814]),
                        (0.7979798 , [0.987622, 0.645320, 0.039886]),
                        (0.80808081, [0.987926, 0.660250, 0.051750]),
                        (0.81818182, [0.987714, 0.682807, 0.072489]),
                        (0.82828283, [0.986694, 0.705540, 0.095694]),
                        (0.83838384, [0.985566, 0.720782, 0.112229]),
                        (0.84848485, [0.983196, 0.743758, 0.138453]),
                        (0.85858586, [0.981173, 0.759135, 0.156863]),
                        (0.86868687, [0.977497, 0.782258, 0.185923]),
                        (0.87878788, [0.974638, 0.797692, 0.206332]),
                        (0.88888889, [0.969783, 0.820825, 0.238686]),
                        (0.8989899 , [0.964394, 0.843848, 0.273391]),
                        (0.90909091, [0.960626, 0.859069, 0.298010]),
                        (0.91919192, [0.954997, 0.881569, 0.337475]),
                        (0.92929293, [0.951546, 0.896226, 0.365627]),
                        (0.93939394, [0.947594, 0.917399, 0.410665]),
                        (0.94949495, [0.946403, 0.937159, 0.458592]),
                        (0.95959596, [0.947937, 0.949318, 0.491426]),
                        (0.96969697, [0.954529, 0.965896, 0.540361]),
                        (0.97979798, [0.961812, 0.975924, 0.571925]),
                        (0.98989899, [0.976511, 0.989753, 0.616760]),
                        (1.        , [0.988362, 0.998364, 0.644924])],
            Magma=[ (0.        , [0.001462, 0.000466, 0.013866]),
                    (0.01010101, [0.003279, 0.002305, 0.023708]),
                    (0.02020202, [0.007588, 0.006356, 0.044973]),
                    (0.03030303, [0.011465, 0.009828, 0.060750]),
                    (0.04040404, [0.018815, 0.016026, 0.084584]),
                    (0.05050505, [0.024792, 0.020715, 0.100676]),
                    (0.06060606, [0.035520, 0.028397, 0.125209]),
                    (0.07070707, [0.048062, 0.036607, 0.150327]),
                    (0.08080808, [0.056615, 0.042160, 0.167446]),
                    (0.09090909, [0.069764, 0.049726, 0.193735]),
                    (0.1010101 , [0.078815, 0.054184, 0.211667]),
                    (0.11111111, [0.092949, 0.059904, 0.239164]),
                    (0.12121212, [0.107899, 0.064335, 0.267289]),
                    (0.13131313, [0.118405, 0.066479, 0.286321]),
                    (0.14141414, [0.135053, 0.068391, 0.315000]),
                    (0.15151515, [0.146785, 0.068738, 0.334011]),
                    (0.16161616, [0.165308, 0.067911, 0.361816]),
                    (0.17171717, [0.178212, 0.066576, 0.379497]),
                    (0.18181818, [0.198177, 0.063862, 0.404009]),
                    (0.19191919, [0.218512, 0.061158, 0.425392]),
                    (0.2020202 , [0.232077, 0.059889, 0.437695]),
                    (0.21212121, [0.252220, 0.059415, 0.453248]),
                    (0.22222222, [0.265447, 0.060237, 0.461840]),
                    (0.23232323, [0.284951, 0.063168, 0.472451]),
                    (0.24242424, [0.304081, 0.067835, 0.480812]),
                    (0.25252525, [0.316654, 0.071690, 0.485380]),
                    (0.26262626, [0.335308, 0.078236, 0.491024]),
                    (0.27272727, [0.347636, 0.082946, 0.494121]),
                    (0.28282828, [0.366012, 0.090314, 0.497960]),
                    (0.29292929, [0.378211, 0.095332, 0.500067]),
                    (0.3030303 , [0.396467, 0.102902, 0.502658]),
                    (0.31313131, [0.414709, 0.110431, 0.504662]),
                    (0.32323232, [0.426877, 0.115395, 0.505714]),
                    (0.33333333, [0.445163, 0.122724, 0.506901]),
                    (0.34343434, [0.457386, 0.127522, 0.507448]),
                    (0.35353535, [0.475780, 0.134577, 0.507921]),
                    (0.36363636, [0.494258, 0.141462, 0.507988]),
                    (0.37373737, [0.506629, 0.145958, 0.507806]),
                    (0.38383838, [0.525270, 0.152569, 0.507192]),
                    (0.39393939, [0.537755, 0.156894, 0.506551]),
                    (0.4040404 , [0.556571, 0.163269, 0.505230]),
                    (0.41414141, [0.575490, 0.169530, 0.503466]),
                    (0.42424242, [0.588158, 0.173652, 0.502035]),
                    (0.43434343, [0.607238, 0.179779, 0.499492]),
                    (0.44444444, [0.620005, 0.183840, 0.497524]),
                    (0.45454545, [0.639216, 0.189921, 0.494150]),
                    (0.46464646, [0.652056, 0.193986, 0.491611]),
                    (0.47474747, [0.671349, 0.200133, 0.487358]),
                    (0.48484848, [0.690661, 0.206384, 0.482558]),
                    (0.49494949, [0.703532, 0.210638, 0.479049]),
                    (0.50505051, [0.722805, 0.217194, 0.473316]),
                    (0.51515152, [0.735616, 0.221713, 0.469180]),
                    (0.52525253, [0.754737, 0.228772, 0.462509]),
                    (0.53535354, [0.773695, 0.236249, 0.455289]),
                    (0.54545455, [0.786212, 0.241514, 0.450184]),
                    (0.55555556, [0.804752, 0.249911, 0.442102]),
                    (0.56565657, [0.816914, 0.255895, 0.436461]),
                    (0.57575758, [0.834791, 0.265540, 0.427671]),
                    (0.58585859, [0.846416, 0.272473, 0.421631]),
                    (0.5959596 , [0.863320, 0.283729, 0.412403]),
                    (0.60606061, [0.879464, 0.296125, 0.403118]),
                    (0.61616162, [0.889731, 0.305079, 0.397002]),
                    (0.62626263, [0.904281, 0.319610, 0.388137]),
                    (0.63636364, [0.913354, 0.330052, 0.382563]),
                    (0.64646465, [0.925937, 0.346844, 0.374959]),
                    (0.65656566, [0.937221, 0.364929, 0.368567]),
                    (0.66666667, [0.944006, 0.377643, 0.365136]),
                    (0.67676768, [0.953099, 0.397563, 0.361438]),
                    (0.68686869, [0.958464, 0.411324, 0.360014]),
                    (0.6969697 , [0.965549, 0.432519, 0.359529]),
                    (0.70707071, [0.971582, 0.454210, 0.361030]),
                    (0.71717172, [0.975082, 0.468861, 0.363111]),
                    (0.72727273, [0.979645, 0.491014, 0.367783]),
                    (0.73737374, [0.982279, 0.505851, 0.371874]),
                    (0.74747475, [0.985693, 0.528148, 0.379371]),
                    (0.75757576, [0.987646, 0.543015, 0.385210]),
                    (0.76767677, [0.990138, 0.565296, 0.395122]),
                    (0.77777778, [0.992196, 0.587502, 0.406299]),
                    (0.78787879, [0.993326, 0.602275, 0.414390]),
                    (0.7979798 , [0.994738, 0.624350, 0.427397]),
                    (0.80808081, [0.995480, 0.639027, 0.436607]),
                    (0.81818182, [0.996341, 0.660969, 0.451160]),
                    (0.82828283, [0.996925, 0.682828, 0.466526]),
                    (0.83838384, [0.997186, 0.697349, 0.477182]),
                    (0.84848485, [0.997351, 0.719089, 0.493755]),
                    (0.85858586, [0.997341, 0.733545, 0.505167]),
                    (0.86868687, [0.997138, 0.755190, 0.522806]),
                    (0.87878788, [0.996898, 0.769591, 0.534892]),
                    (0.88888889, [0.996369, 0.791167, 0.553499]),
                    (0.8989899 , [0.995680, 0.812706, 0.572645]),
                    (0.90909091, [0.995131, 0.827052, 0.585701]),
                    (0.91919192, [0.994222, 0.848540, 0.605696]),
                    (0.92929293, [0.993545, 0.862859, 0.619299]),
                    (0.93939394, [0.992440, 0.884330, 0.640099]),
                    (0.94949495, [0.991332, 0.905763, 0.661309]),
                    (0.95959596, [0.990570, 0.920049, 0.675675]),
                    (0.96969697, [0.989434, 0.941470, 0.697519]),
                    (0.97979798, [0.988717, 0.955742, 0.712242]),
                    (0.98989899, [0.987691, 0.977154, 0.734536]),
                    (1.        , [0.987053, 0.991438, 0.749504])],
            Plasma=[ (0.        , [0.050383, 0.029803, 0.527975]),
                    (0.01010101, [0.075353, 0.027206, 0.538007]),
                    (0.02020202, [0.105980, 0.024309, 0.551368]),
                    (0.03030303, [0.123903, 0.022878, 0.559423]),
                    (0.04040404, [0.148607, 0.021154, 0.570562]),
                    (0.05050505, [0.164070, 0.020171, 0.577478]),
                    (0.06060606, [0.186213, 0.018803, 0.587228]),
                    (0.07070707, [0.207435, 0.017442, 0.596333]),
                    (0.08080808, [0.221197, 0.016497, 0.602083]),
                    (0.09090909, [0.241396, 0.014979, 0.610259]),
                    (0.1010101 , [0.254627, 0.013882, 0.615419]),
                    (0.11111111, [0.274191, 0.012109, 0.622722]),
                    (0.12121212, [0.293478, 0.010213, 0.629490]),
                    (0.13131313, [0.306210, 0.008902, 0.633694]),
                    (0.14141414, [0.325150, 0.006915, 0.639512]),
                    (0.15151515, [0.337683, 0.005618, 0.643049]),
                    (0.16161616, [0.356359, 0.003798, 0.647810]),
                    (0.17171717, [0.368733, 0.002724, 0.650601]),
                    (0.18181818, [0.387183, 0.001434, 0.654177]),
                    (0.19191919, [0.405503, 0.000678, 0.656977]),
                    (0.2020202 , [0.417642, 0.000564, 0.658390]),
                    (0.21212121, [0.435734, 0.001127, 0.659797]),
                    (0.22222222, [0.447714, 0.002080, 0.660240]),
                    (0.23232323, [0.465550, 0.004545, 0.660139]),
                    (0.24242424, [0.483210, 0.008460, 0.659095]),
                    (0.25252525, [0.494877, 0.011990, 0.657865]),
                    (0.26262626, [0.512206, 0.018833, 0.655209]),
                    (0.27272727, [0.523633, 0.024532, 0.652901]),
                    (0.28282828, [0.540570, 0.034950, 0.648640]),
                    (0.29292929, [0.551715, 0.043136, 0.645277]),
                    (0.3030303 , [0.568201, 0.055778, 0.639477]),
                    (0.31313131, [0.584391, 0.068579, 0.632812]),
                    (0.32323232, [0.595011, 0.077190, 0.627917]),
                    (0.33333333, [0.610667, 0.090204, 0.619951]),
                    (0.34343434, [0.620919, 0.098934, 0.614257]),
                    (0.35353535, [0.636008, 0.112092, 0.605205]),
                    (0.36363636, [0.650746, 0.125309, 0.595617]),
                    (0.37373737, [0.660374, 0.134144, 0.588971]),
                    (0.38383838, [0.674522, 0.147419, 0.578688]),
                    (0.39393939, [0.683758, 0.156278, 0.571660]),
                    (0.4040404 , [0.697324, 0.169573, 0.560919]),
                    (0.41414141, [0.710549, 0.182868, 0.550004]),
                    (0.42424242, [0.719181, 0.191729, 0.542663]),
                    (0.43434343, [0.731862, 0.205013, 0.531601]),
                    (0.44444444, [0.740143, 0.213864, 0.524216]),
                    (0.45454545, [0.752312, 0.227133, 0.513149]),
                    (0.46464646, [0.760264, 0.235976, 0.505794]),
                    (0.47474747, [0.771958, 0.249237, 0.494813]),
                    (0.48484848, [0.783383, 0.262500, 0.483918]),
                    (0.49494949, [0.790855, 0.271345, 0.476706]),
                    (0.50505051, [0.801855, 0.284626, 0.465971]),
                    (0.51515152, [0.809052, 0.293491, 0.458870]),
                    (0.52525253, [0.819651, 0.306812, 0.448306]),
                    (0.53535354, [0.830018, 0.320172, 0.437836]),
                    (0.54545455, [0.836801, 0.329105, 0.430905]),
                    (0.55555556, [0.846788, 0.342551, 0.420579]),
                    (0.56565657, [0.853319, 0.351553, 0.413734]),
                    (0.57575758, [0.862927, 0.365119, 0.403519]),
                    (0.58585859, [0.869203, 0.374212, 0.396738]),
                    (0.5959596 , [0.878423, 0.387932, 0.386600]),
                    (0.60606061, [0.887402, 0.401762, 0.376494]),
                    (0.61616162, [0.893250, 0.411048, 0.369768]),
                    (0.62626263, [0.901807, 0.425087, 0.359688]),
                    (0.63636364, [0.907365, 0.434524, 0.352970]),
                    (0.64646465, [0.915471, 0.448807, 0.342890]),
                    (0.65656566, [0.923287, 0.463251, 0.332801]),
                    (0.66666667, [0.928329, 0.472975, 0.326067]),
                    (0.67676768, [0.935630, 0.487712, 0.315952]),
                    (0.68686869, [0.940313, 0.497642, 0.309197]),
                    (0.6969697 , [0.947051, 0.512699, 0.299049]),
                    (0.70707071, [0.953428, 0.527960, 0.288883]),
                    (0.71717172, [0.957469, 0.538250, 0.282096]),
                    (0.72727273, [0.963203, 0.553865, 0.271909]),
                    (0.73737374, [0.966798, 0.564396, 0.265118]),
                    (0.74747475, [0.971835, 0.580382, 0.254931]),
                    (0.75757576, [0.974947, 0.591165, 0.248151]),
                    (0.76767677, [0.979233, 0.607532, 0.238013]),
                    (0.77777778, [0.983041, 0.624131, 0.227937]),
                    (0.78787879, [0.985301, 0.635330, 0.221265]),
                    (0.7979798 , [0.988260, 0.652325, 0.211364]),
                    (0.80808081, [0.989935, 0.663787, 0.204859]),
                    (0.81818182, [0.991985, 0.681179, 0.195295]),
                    (0.82828283, [0.993456, 0.698810, 0.186041]),
                    (0.83838384, [0.994103, 0.710698, 0.180097]),
                    (0.84848485, [0.994553, 0.728728, 0.171622]),
                    (0.85858586, [0.994495, 0.740880, 0.166335]),
                    (0.86868687, [0.993851, 0.759304, 0.159092]),
                    (0.87878788, [0.993033, 0.771720, 0.154808]),
                    (0.88888889, [0.991209, 0.790537, 0.149377]),
                    (0.8989899 , [0.988648, 0.809579, 0.145357]),
                    (0.90909091, [0.986509, 0.822401, 0.143557]),
                    (0.91919192, [0.982653, 0.841812, 0.142303]),
                    (0.92929293, [0.979644, 0.854866, 0.142453]),
                    (0.93939394, [0.974443, 0.874622, 0.144061]),
                    (0.94949495, [0.968443, 0.894564, 0.147014]),
                    (0.95959596, [0.964021, 0.907950, 0.149370]),
                    (0.96969697, [0.956808, 0.928152, 0.152409]),
                    (0.97979798, [0.951726, 0.941671, 0.152925]),
                    (0.98989899, [0.944152, 0.961916, 0.146861]),
                    (1.        , [0.940015, 0.975158, 0.131326])],
            NiceBlue=[(0.00,[255./255.,255./255.,255./255.]),
                      (0.50,[0./255.,97./255.,165./255.]),
                      (1.00,[0./255.,0./255.,0./255.])],
            Greys=[ (0.        , [1.000000, 1.000000, 1.000000]),
                    (0.01010101, [0.995247, 0.995247, 0.995247]),
                    (0.02020202, [0.990493, 0.990493, 0.990493]),
                    (0.03030303, [0.985740, 0.985740, 0.985740]),
                    (0.04040404, [0.980986, 0.980986, 0.980986]),
                    (0.05050505, [0.976233, 0.976233, 0.976233]),
                    (0.06060606, [0.971480, 0.971480, 0.971480]),
                    (0.07070707, [0.966726, 0.966726, 0.966726]),
                    (0.08080808, [0.961973, 0.961973, 0.961973]),
                    (0.09090909, [0.957219, 0.957219, 0.957219]),
                    (0.1010101 , [0.952466, 0.952466, 0.952466]),
                    (0.11111111, [0.947712, 0.947712, 0.947712]),
                    (0.12121212, [0.942959, 0.942959, 0.942959]),
                    (0.13131313, [0.936621, 0.936621, 0.936621]),
                    (0.14141414, [0.929333, 0.929333, 0.929333]),
                    (0.15151515, [0.922044, 0.922044, 0.922044]),
                    (0.16161616, [0.914755, 0.914755, 0.914755]),
                    (0.17171717, [0.907467, 0.907467, 0.907467]),
                    (0.18181818, [0.900178, 0.900178, 0.900178]),
                    (0.19191919, [0.892890, 0.892890, 0.892890]),
                    (0.2020202 , [0.885601, 0.885601, 0.885601]),
                    (0.21212121, [0.878313, 0.878313, 0.878313]),
                    (0.22222222, [0.871024, 0.871024, 0.871024]),
                    (0.23232323, [0.863735, 0.863735, 0.863735]),
                    (0.24242424, [0.856447, 0.856447, 0.856447]),
                    (0.25252525, [0.848762, 0.848762, 0.848762]),
                    (0.26262626, [0.839889, 0.839889, 0.839889]),
                    (0.27272727, [0.831016, 0.831016, 0.831016]),
                    (0.28282828, [0.822143, 0.822143, 0.822143]),
                    (0.29292929, [0.813270, 0.813270, 0.813270]),
                    (0.3030303 , [0.804397, 0.804397, 0.804397]),
                    (0.31313131, [0.795524, 0.795524, 0.795524]),
                    (0.32323232, [0.786651, 0.786651, 0.786651]),
                    (0.33333333, [0.777778, 0.777778, 0.777778]),
                    (0.34343434, [0.768905, 0.768905, 0.768905]),
                    (0.35353535, [0.760032, 0.760032, 0.760032]),
                    (0.36363636, [0.751159, 0.751159, 0.751159]),
                    (0.37373737, [0.742286, 0.742286, 0.742286]),
                    (0.38383838, [0.730362, 0.730362, 0.730362]),
                    (0.39393939, [0.718004, 0.718004, 0.718004]),
                    (0.4040404 , [0.705645, 0.705645, 0.705645]),
                    (0.41414141, [0.693286, 0.693286, 0.693286]),
                    (0.42424242, [0.680927, 0.680927, 0.680927]),
                    (0.43434343, [0.668568, 0.668568, 0.668568]),
                    (0.44444444, [0.656209, 0.656209, 0.656209]),
                    (0.45454545, [0.643850, 0.643850, 0.643850]),
                    (0.46464646, [0.631491, 0.631491, 0.631491]),
                    (0.47474747, [0.619133, 0.619133, 0.619133]),
                    (0.48484848, [0.606774, 0.606774, 0.606774]),
                    (0.49494949, [0.594415, 0.594415, 0.594415]),
                    (0.50505051, [0.582690, 0.582690, 0.582690]),
                    (0.51515152, [0.571598, 0.571598, 0.571598]),
                    (0.52525253, [0.560507, 0.560507, 0.560507]),
                    (0.53535354, [0.549416, 0.549416, 0.549416]),
                    (0.54545455, [0.538324, 0.538324, 0.538324]),
                    (0.55555556, [0.527233, 0.527233, 0.527233]),
                    (0.56565657, [0.516142, 0.516142, 0.516142]),
                    (0.57575758, [0.505051, 0.505051, 0.505051]),
                    (0.58585859, [0.493959, 0.493959, 0.493959]),
                    (0.5959596 , [0.482868, 0.482868, 0.482868]),
                    (0.60606061, [0.471777, 0.471777, 0.471777]),
                    (0.61616162, [0.460685, 0.460685, 0.460685]),
                    (0.62626263, [0.449673, 0.449673, 0.449673]),
                    (0.63636364, [0.439216, 0.439216, 0.439216]),
                    (0.64646465, [0.428758, 0.428758, 0.428758]),
                    (0.65656566, [0.418301, 0.418301, 0.418301]),
                    (0.66666667, [0.407843, 0.407843, 0.407843]),
                    (0.67676768, [0.397386, 0.397386, 0.397386]),
                    (0.68686869, [0.386928, 0.386928, 0.386928]),
                    (0.6969697 , [0.376471, 0.376471, 0.376471]),
                    (0.70707071, [0.366013, 0.366013, 0.366013]),
                    (0.71717172, [0.355556, 0.355556, 0.355556]),
                    (0.72727273, [0.345098, 0.345098, 0.345098]),
                    (0.73737374, [0.334641, 0.334641, 0.334641]),
                    (0.74747475, [0.324183, 0.324183, 0.324183]),
                    (0.75757576, [0.310873, 0.310873, 0.310873]),
                    (0.76767677, [0.296613, 0.296613, 0.296613]),
                    (0.77777778, [0.282353, 0.282353, 0.282353]),
                    (0.78787879, [0.268093, 0.268093, 0.268093]),
                    (0.7979798 , [0.253832, 0.253832, 0.253832]),
                    (0.80808081, [0.239572, 0.239572, 0.239572]),
                    (0.81818182, [0.225312, 0.225312, 0.225312]),
                    (0.82828283, [0.211052, 0.211052, 0.211052]),
                    (0.83838384, [0.196791, 0.196791, 0.196791]),
                    (0.84848485, [0.182531, 0.182531, 0.182531]),
                    (0.85858586, [0.168271, 0.168271, 0.168271]),
                    (0.86868687, [0.154011, 0.154011, 0.154011]),
                    (0.87878788, [0.140701, 0.140701, 0.140701]),
                    (0.88888889, [0.128976, 0.128976, 0.128976]),
                    (0.8989899 , [0.117251, 0.117251, 0.117251]),
                    (0.90909091, [0.105526, 0.105526, 0.105526]),
                    (0.91919192, [0.093801, 0.093801, 0.093801]),
                    (0.92929293, [0.082076, 0.082076, 0.082076]),
                    (0.93939394, [0.070351, 0.070351, 0.070351]),
                    (0.94949495, [0.058625, 0.058625, 0.058625]),
                    (0.95959596, [0.046900, 0.046900, 0.046900]),
                    (0.96969697, [0.035175, 0.035175, 0.035175]),
                    (0.97979798, [0.023450, 0.023450, 0.023450]),
                    (0.98989899, [0.011725, 0.011725, 0.011725]),
                    (1.        , [0.000000, 0.000000, 0.000000])],
            Greens=[ (0.        , [0.968627, 0.988235, 0.960784]),
                    (0.01010101, [0.962923, 0.986017, 0.954130]),
                    (0.02020202, [0.957219, 0.983799, 0.947475]),
                    (0.03030303, [0.951515, 0.981581, 0.940820]),
                    (0.04040404, [0.945811, 0.979362, 0.934165]),
                    (0.05050505, [0.940107, 0.977144, 0.927510]),
                    (0.06060606, [0.934403, 0.974926, 0.920856]),
                    (0.07070707, [0.928699, 0.972707, 0.914201]),
                    (0.08080808, [0.922995, 0.970489, 0.907546]),
                    (0.09090909, [0.917291, 0.968271, 0.900891]),
                    (0.1010101 , [0.911586, 0.966053, 0.894236]),
                    (0.11111111, [0.905882, 0.963834, 0.887582]),
                    (0.12121212, [0.900178, 0.961616, 0.880927]),
                    (0.13131313, [0.892097, 0.958408, 0.872093]),
                    (0.14141414, [0.882591, 0.954605, 0.861953]),
                    (0.15151515, [0.873084, 0.950802, 0.851812]),
                    (0.16161616, [0.863577, 0.946999, 0.841672]),
                    (0.17171717, [0.854070, 0.943197, 0.831531]),
                    (0.18181818, [0.844563, 0.939394, 0.821390]),
                    (0.19191919, [0.835056, 0.935591, 0.811250]),
                    (0.2020202 , [0.825550, 0.931788, 0.801109]),
                    (0.21212121, [0.816043, 0.927986, 0.790969]),
                    (0.22222222, [0.806536, 0.924183, 0.780828]),
                    (0.23232323, [0.797029, 0.920380, 0.770687]),
                    (0.24242424, [0.787522, 0.916578, 0.760547]),
                    (0.25252525, [0.777382, 0.912458, 0.750010]),
                    (0.26262626, [0.765340, 0.907388, 0.738285]),
                    (0.27272727, [0.753298, 0.902317, 0.726560]),
                    (0.28282828, [0.741256, 0.897247, 0.714835]),
                    (0.29292929, [0.729214, 0.892177, 0.703110]),
                    (0.3030303 , [0.717172, 0.887106, 0.691384]),
                    (0.31313131, [0.705130, 0.882036, 0.679659]),
                    (0.32323232, [0.693088, 0.876966, 0.667934]),
                    (0.33333333, [0.681046, 0.871895, 0.656209]),
                    (0.34343434, [0.669004, 0.866825, 0.644484]),
                    (0.35353535, [0.656962, 0.861755, 0.632759]),
                    (0.36363636, [0.644920, 0.856684, 0.621034]),
                    (0.37373737, [0.632878, 0.851614, 0.609309]),
                    (0.38383838, [0.618895, 0.845157, 0.597584]),
                    (0.39393939, [0.604635, 0.838503, 0.585859]),
                    (0.4040404 , [0.590374, 0.831848, 0.574133]),
                    (0.41414141, [0.576114, 0.825193, 0.562408]),
                    (0.42424242, [0.561854, 0.818538, 0.550683]),
                    (0.43434343, [0.547594, 0.811884, 0.538958]),
                    (0.44444444, [0.533333, 0.805229, 0.527233]),
                    (0.45454545, [0.519073, 0.798574, 0.515508]),
                    (0.46464646, [0.504813, 0.791919, 0.503783]),
                    (0.47474747, [0.490553, 0.785264, 0.492058]),
                    (0.48484848, [0.476292, 0.778610, 0.480333]),
                    (0.49494949, [0.462032, 0.771955, 0.468608]),
                    (0.50505051, [0.446821, 0.764666, 0.458784]),
                    (0.51515152, [0.430660, 0.756744, 0.450862]),
                    (0.52525253, [0.414498, 0.748822, 0.442939]),
                    (0.53535354, [0.398336, 0.740899, 0.435017]),
                    (0.54545455, [0.382175, 0.732977, 0.427094]),
                    (0.55555556, [0.366013, 0.725054, 0.419172]),
                    (0.56565657, [0.349851, 0.717132, 0.411250]),
                    (0.57575758, [0.333690, 0.709210, 0.403327]),
                    (0.58585859, [0.317528, 0.701287, 0.395405]),
                    (0.5959596 , [0.301367, 0.693365, 0.387483]),
                    (0.60606061, [0.285205, 0.685443, 0.379560]),
                    (0.61616162, [0.269043, 0.677520, 0.371638]),
                    (0.62626263, [0.253714, 0.669321, 0.363755]),
                    (0.63636364, [0.244207, 0.659180, 0.356150]),
                    (0.64646465, [0.234700, 0.649039, 0.348544]),
                    (0.65656566, [0.225193, 0.638899, 0.340939]),
                    (0.66666667, [0.215686, 0.628758, 0.333333]),
                    (0.67676768, [0.206179, 0.618618, 0.325728]),
                    (0.68686869, [0.196673, 0.608477, 0.318122]),
                    (0.6969697 , [0.187166, 0.598336, 0.310517]),
                    (0.70707071, [0.177659, 0.588196, 0.302911]),
                    (0.71717172, [0.168152, 0.578055, 0.295306]),
                    (0.72727273, [0.158645, 0.567914, 0.287701]),
                    (0.73737374, [0.149138, 0.557774, 0.280095]),
                    (0.74747475, [0.139632, 0.547633, 0.272490]),
                    (0.75757576, [0.128936, 0.537968, 0.264646]),
                    (0.76767677, [0.117845, 0.528461, 0.256724]),
                    (0.77777778, [0.106754, 0.518954, 0.248802]),
                    (0.78787879, [0.095663, 0.509447, 0.240879]),
                    (0.7979798 , [0.084571, 0.499941, 0.232957]),
                    (0.80808081, [0.073480, 0.490434, 0.225035]),
                    (0.81818182, [0.062389, 0.480927, 0.217112]),
                    (0.82828283, [0.051297, 0.471420, 0.209190]),
                    (0.83838384, [0.040206, 0.461913, 0.201268]),
                    (0.84848485, [0.029115, 0.452406, 0.193345]),
                    (0.85858586, [0.018023, 0.442900, 0.185423]),
                    (0.86868687, [0.006932, 0.433393, 0.177500]),
                    (0.87878788, [0.000000, 0.422579, 0.170529]),
                    (0.88888889, [0.000000, 0.409586, 0.165142]),
                    (0.8989899 , [0.000000, 0.396593, 0.159754]),
                    (0.90909091, [0.000000, 0.383601, 0.154367]),
                    (0.91919192, [0.000000, 0.370608, 0.148980]),
                    (0.92929293, [0.000000, 0.357615, 0.143593]),
                    (0.93939394, [0.000000, 0.344623, 0.138206]),
                    (0.94949495, [0.000000, 0.331630, 0.132818]),
                    (0.95959596, [0.000000, 0.318637, 0.127431]),
                    (0.96969697, [0.000000, 0.305645, 0.122044]),
                    (0.97979798, [0.000000, 0.292652, 0.116657]),
                    (0.98989899, [0.000000, 0.279659, 0.111270]),
                    (1.        , [0.000000, 0.266667, 0.105882])],
        Jet=[ (0.        , [0.000000, 0.000000, 0.500000]),
                (0.01010101, [0.000000, 0.000000, 0.545914]),
                (0.02020202, [0.000000, 0.000000, 0.591827]),
                (0.03030303, [0.000000, 0.000000, 0.637741]),
                (0.04040404, [0.000000, 0.000000, 0.683655]),
                (0.05050505, [0.000000, 0.000000, 0.729568]),
                (0.06060606, [0.000000, 0.000000, 0.775482]),
                (0.07070707, [0.000000, 0.000000, 0.821396]),
                (0.08080808, [0.000000, 0.000000, 0.867309]),
                (0.09090909, [0.000000, 0.000000, 0.913223]),
                (0.1010101 , [0.000000, 0.000000, 0.959137]),
                (0.11111111, [0.000000, 0.000000, 1.000000]),
                (0.12121212, [0.000000, 0.000000, 1.000000]),
                (0.13131313, [0.000000, 0.025253, 1.000000]),
                (0.14141414, [0.000000, 0.065657, 1.000000]),
                (0.15151515, [0.000000, 0.106061, 1.000000]),
                (0.16161616, [0.000000, 0.146465, 1.000000]),
                (0.17171717, [0.000000, 0.186869, 1.000000]),
                (0.18181818, [0.000000, 0.227273, 1.000000]),
                (0.19191919, [0.000000, 0.267677, 1.000000]),
                (0.2020202 , [0.000000, 0.308081, 1.000000]),
                (0.21212121, [0.000000, 0.348485, 1.000000]),
                (0.22222222, [0.000000, 0.388889, 1.000000]),
                (0.23232323, [0.000000, 0.429293, 1.000000]),
                (0.24242424, [0.000000, 0.469697, 1.000000]),
                (0.25252525, [0.000000, 0.510101, 1.000000]),
                (0.26262626, [0.000000, 0.550505, 1.000000]),
                (0.27272727, [0.000000, 0.590909, 1.000000]),
                (0.28282828, [0.000000, 0.631313, 1.000000]),
                (0.29292929, [0.000000, 0.671717, 1.000000]),
                (0.3030303 , [0.000000, 0.712121, 1.000000]),
                (0.31313131, [0.000000, 0.752525, 1.000000]),
                (0.32323232, [0.000000, 0.792929, 1.000000]),
                (0.33333333, [0.000000, 0.833333, 1.000000]),
                (0.34343434, [0.000000, 0.873737, 0.988921]),
                (0.35353535, [0.011404, 0.914141, 0.956338]),
                (0.36363636, [0.043988, 0.954545, 0.923754]),
                (0.37373737, [0.076572, 0.994949, 0.891170]),
                (0.38383838, [0.109156, 1.000000, 0.858586]),
                (0.39393939, [0.141740, 1.000000, 0.826002]),
                (0.4040404 , [0.174324, 1.000000, 0.793418]),
                (0.41414141, [0.206908, 1.000000, 0.760834]),
                (0.42424242, [0.239492, 1.000000, 0.728250]),
                (0.43434343, [0.272076, 1.000000, 0.695666]),
                (0.44444444, [0.304659, 1.000000, 0.663082]),
                (0.45454545, [0.337243, 1.000000, 0.630499]),
                (0.46464646, [0.369827, 1.000000, 0.597915]),
                (0.47474747, [0.402411, 1.000000, 0.565331]),
                (0.48484848, [0.434995, 1.000000, 0.532747]),
                (0.49494949, [0.467579, 1.000000, 0.500163]),
                (0.50505051, [0.500163, 1.000000, 0.467579]),
                (0.51515152, [0.532747, 1.000000, 0.434995]),
                (0.52525253, [0.565331, 1.000000, 0.402411]),
                (0.53535354, [0.597915, 1.000000, 0.369827]),
                (0.54545455, [0.630499, 1.000000, 0.337243]),
                (0.55555556, [0.663082, 1.000000, 0.304659]),
                (0.56565657, [0.695666, 1.000000, 0.272076]),
                (0.57575758, [0.728250, 1.000000, 0.239492]),
                (0.58585859, [0.760834, 1.000000, 0.206908]),
                (0.5959596 , [0.793418, 1.000000, 0.174324]),
                (0.60606061, [0.826002, 1.000000, 0.141740]),
                (0.61616162, [0.858586, 1.000000, 0.109156]),
                (0.62626263, [0.891170, 1.000000, 0.076572]),
                (0.63636364, [0.923754, 1.000000, 0.043988]),
                (0.64646465, [0.956338, 0.976057, 0.011404]),
                (0.65656566, [0.988921, 0.938646, 0.000000]),
                (0.66666667, [1.000000, 0.901235, 0.000000]),
                (0.67676768, [1.000000, 0.863823, 0.000000]),
                (0.68686869, [1.000000, 0.826412, 0.000000]),
                (0.6969697 , [1.000000, 0.789001, 0.000000]),
                (0.70707071, [1.000000, 0.751590, 0.000000]),
                (0.71717172, [1.000000, 0.714179, 0.000000]),
                (0.72727273, [1.000000, 0.676768, 0.000000]),
                (0.73737374, [1.000000, 0.639357, 0.000000]),
                (0.74747475, [1.000000, 0.601945, 0.000000]),
                (0.75757576, [1.000000, 0.564534, 0.000000]),
                (0.76767677, [1.000000, 0.527123, 0.000000]),
                (0.77777778, [1.000000, 0.489712, 0.000000]),
                (0.78787879, [1.000000, 0.452301, 0.000000]),
                (0.7979798 , [1.000000, 0.414890, 0.000000]),
                (0.80808081, [1.000000, 0.377478, 0.000000]),
                (0.81818182, [1.000000, 0.340067, 0.000000]),
                (0.82828283, [1.000000, 0.302656, 0.000000]),
                (0.83838384, [1.000000, 0.265245, 0.000000]),
                (0.84848485, [1.000000, 0.227834, 0.000000]),
                (0.85858586, [1.000000, 0.190423, 0.000000]),
                (0.86868687, [1.000000, 0.153012, 0.000000]),
                (0.87878788, [1.000000, 0.115600, 0.000000]),
                (0.88888889, [1.000000, 0.078189, 0.000000]),
                (0.8989899 , [0.959137, 0.040778, 0.000000]),
                (0.90909091, [0.913223, 0.003367, 0.000000]),
                (0.91919192, [0.867309, 0.000000, 0.000000]),
                (0.92929293, [0.821396, 0.000000, 0.000000]),
                (0.93939394, [0.775482, 0.000000, 0.000000]),
                (0.94949495, [0.729568, 0.000000, 0.000000]),
                (0.95959596, [0.683655, 0.000000, 0.000000]),
                (0.96969697, [0.637741, 0.000000, 0.000000]),
                (0.97979798, [0.591827, 0.000000, 0.000000]),
                (0.98989899, [0.545914, 0.000000, 0.000000]),
                (1.        , [0.500000, 0.000000, 0.000000])],
                                                ) 

        self.colormaps = dict()
        for color_code in self.color_codes:
            self.colormaps[color_code] = LinearSegmentedColormap.from_list(color_code,
                self.color_codes[color_code])

    def addColorbar(self, field_name='', orientation='vertical', center=(0.90,0.5),
                          width=0.025, length=0.8, number_of_ticks=5, extend='neither',
                          font_color='black', colorbar_title='',
                          ticks_opposed_side=False, ticks_format='%g', 
                          ticks_size='medium', title_size='large'):
        # ticks_size and title_size can be: float or {'xx-small', 'x-small', 'small', 'medium', 'large', 'x-large', 'xx-large'}
        if not self.fig: 
            self.createOverlap()
        
        levels = None
        cmap = None
        for elt in self.Elements:
            try: field = elt['color'].replace('Iso:','')
            except KeyError: continue
            if field == field_name:
                levels = elt['levels']
                cmap = elt['colormap']
                break
        if not levels:
            raise ValueError('element with color=Iso:%s bad defined.'%field_name)
    
        if orientation not in ('vertical','horizontal'):
            raise ValueError("orientation must be 'vertical' or 'horizontal'")

        if orientation == 'horizontal':
            xmin = center[0]-length/2.0
            xmax = center[0]+length/2.0
            ymin = center[1]-width/2.0
            ymax = center[1]+width/2.0
        else:
            xmin = center[0]-width/2.0
            xmax = center[0]+width/2.0
            ymin = center[1]-length/2.0
            ymax = center[1]+length/2.0

        cbar_ticks = np.linspace(levels[1],levels[2],number_of_ticks)
        cbaxes = self.fig.add_axes([xmin,ymin,xmax-xmin,ymax-ymin])

        if cmap == 'Jet':
            colormap = self.colormaps[cmap].reversed()
        else:
            colormap = self.colormaps[cmap]
        norm = mplcolors.BoundaryNorm(boundaries=np.linspace(levels[1],levels[2],levels[0]), ncolors=colormap.N, extend=extend) 
        cset = cm.ScalarMappable(norm=norm, cmap=colormap)
        cbar = self.fig.colorbar(cset, cax=cbaxes, orientation=orientation, ticks=cbar_ticks, format=ticks_format)
        cbar.ax.tick_params(which='major', length=4.0, width=0.5, color=font_color, labelsize=ticks_size)
        cbar.ax.tick_params(which='minor', length=0.)
        cbar.ax.xaxis.label.set_color(font_color)
        cbar.ax.yaxis.label.set_color(font_color)
        cbar.ax.tick_params(axis='x',colors=font_color)
        cbar.ax.tick_params(axis='y',colors=font_color)

        if orientation == 'vertical':
            if ticks_opposed_side: cbar.ax.yaxis.set_ticks_position("left")
            else: cbar.ax.yaxis.set_ticks_position("right")

            for value in elt['iso_line']:
                cbar.ax.axhline(y=value, c=elt['iso_line_color'])
        else:
            if ticks_opposed_side: cbar.ax.xaxis.set_ticks_position("top")
            else: cbar.ax.xaxis.set_ticks_position("bottom")

            for value in elt['iso_line']:
                cbar.ax.axvline(x=value, c=elt['iso_line_color'])

        if colorbar_title: cbar.ax.set_title(colorbar_title, color=font_color, fontsize=title_size)
        else:              cbar.ax.set_title(field_name,     color=font_color, fontsize=title_size)
        cbar.update_ticks()
        
        return cbar

    def _loadArrays(self, arrays_file_or_tree):
        if isinstance(arrays_file_or_tree, str):
            self.arrays = C.convertFile2PyTree( arrays_file_or_tree )
        else:
            self.arrays = arrays_file_or_tree

    def plotArrays(self, arrays_file_or_tree=None, left=0.05, right=0.5, bottom=0.05, top=0.4,
            xlim=None, ylim=None, xmax=None, xlabel=None, ylabel=None, figure_name=None,
            background_opacity=1.0, font_color='black', 
            curves=[dict(zone_name='BLADES',x='IterationNumber',y='MomentumXFlux',
                         plot_params={})], 
            iterationTracer=None):
        
        if not self.fig: 
            self.createOverlap()

        if not self.arrays or (arrays_file_or_tree is not None): 
            self._loadArrays(arrays_file_or_tree)
        
        ax = self.fig.add_axes([left,bottom,right-left,top-bottom])

        for curve in curves:
            zone = [z for z in I.getZones(self.arrays) if z[0]==curve['zone_name']]
            if not zone: raise ValueError('zone %s not found in arrays'%curve['zone_name'])
            if len(zone) > 1:
                print('found %d zones with name %s. Will use first found.'%(len(zone),curve['zone_name']))
            zone = zone[0]

            x, y = J.getVars(zone,[curve['x'],curve['y']])
            if x is None: raise ValueError('x variable "%s" not found in %s'%(curve['x'],zone[0]))
            if y is None: raise ValueError('y variable "%s" not found in %s'%(curve['y'],zone[0]))

            if xmax is not None:
                interval = x <= xmax
                x = x[interval]
                y = y[interval]

            ax.plot(x,y,**curve['plot_params'])
            if iterationTracer:
                try:
                    if isinstance(iterationTracer, int):
                        iterationTracer = dict(iteration=iterationTracer)
                    iterations = J.getVars(zone, ['IterationNumber'])[0]
                    # On the following line: -1 because quantities correspond to the previous iteration
                    index = np.where(iterations == iterationTracer['iteration'] - 1)[0]
                    if not 'plot_params' in iterationTracer:
                        iterationTracer['plot_params'] = dict(marker='o', color='red')
                    ax.plot(x[index], y[index], **iterationTracer['plot_params'])
                except:
                    pass

        if xlim is not None: ax.set_xlim(xlim)
        if ylim is not None: ax.set_ylim(ylim)
        if isinstance(xlabel,str): ax.set_xlabel(xlabel)
        else: ax.set_xlabel(curve['x'])
        if isinstance(ylabel,str): ax.set_ylabel(ylabel)
        else:
            ylabels = [c['y'] for c in curves]
            if ylabels.count(ylabels[0]) == len(ylabels):
                ax.set_ylabel(ylabels[0])
        if isinstance(figure_name,str): ax.set_title(figure_name)
        ax.patch.set_alpha(background_opacity)
        self.axes += [ ax ]


        ax.spines['bottom'].set_color(font_color)
        ax.spines['top'].set_color(font_color) 
        ax.spines['right'].set_color(font_color)
        ax.spines['left'].set_color(font_color)
        ax.tick_params(axis='x', colors=font_color)
        ax.tick_params(axis='y', colors=font_color)
        ax.yaxis.label.set_color(font_color)
        ax.xaxis.label.set_color(font_color)
        ax.title.set_color(font_color)


        return ax

    def plot(self, x, y, z, *args, **kwargs):
        if not self.fig: 
            self.createOverlap()

        x = np.array(x, ndmin=1)
        if isinstance(y, (float, int)):
            y = y * np.ones(x.size)
        if isinstance(z, (float, int)):
            z = z * np.ones(x.size)
        points = zip(x, y, z)
        pixels = xyz2Pixel(points, self.window_in_pixels, **self.camera)
        pixels = np.array(pixels)
        u, v = pixels[:,0], pixels[:,1]
        self.axes[0].plot(u, v, *args, **kwargs)


    def save(self, output_filename=''):
        if not output_filename:
            output_filename = self.filename

        DIRECTORY_FRAMES = output_filename.split(os.path.sep)[:-1]    
        try: os.makedirs(os.path.join(*DIRECTORY_FRAMES))
        except: pass

        print(f'saving {output_filename} ...', end=' ')
        plt.savefig(output_filename, dpi=self.dpi)
        print('done')
        for ax in self.axes: ax.clear()
        self.fig.clear()
        plt.close('all')

    def show(self):
        plt.show()


def xyz2Pixel(points,win,posCam,posEye,dirCam,viewAngle=50.0):
    '''
    Returns the two-component image-pixel positions of a set of points
    located in the 3D world of CPlot.

    Parameters
    ----------

        points : :py:class:`list` of 3 :py:class:`float` :py:class:`tuple`
            :math:`(x,y,z)` coordinates of points in 3D world

        win : :py:class:`tuple` of 2 :py:class:`int`
            Window resolution in pixels

        posCam : :py:class:`tuple` of 3 :py:class:`float`
            position of Camera (see CPlot doc)

        posEye : :py:class:`tuple` of 3 :py:class:`float`
            position of eye (see CPlot doc)

        dirCam : :py:class:`tuple` of 3 :py:class:`float`
            direction of Camera (see CPlot doc)

        viewAngle : float
            angle of Camera (see CPlot doc)

    Returns
    -------

        width, height : :py:class:`tuple` of 2 :py:class:`float`
            width and height in pixels using the convention of origin located at
            upper left side of image

    '''

    # ------------------------------- #
    # BUILD FRENET UNIT FRAME (b,n,c) #
    # ------------------------------- #
    # <c> is the Camera axes unit vector
    c =  np.array(posCam) - np.array(posEye)
    R = np.sqrt(c.dot(c)) # R is distance between posCam and posEye
    c /= R

    # <b> is binormal
    b = np.cross(np.array(dirCam),c)
    b /= np.sqrt(b.dot(b))

    # <n> is normal
    n = np.cross(c,b)
    n /= np.sqrt(b.dot(b))

    # <h> is the constant total height of the curvilinear window
    va = np.deg2rad(viewAngle)
    h = R * va
    h = 2 * R * np.tan(va/2.)

    # used to transform curvilinear unit to pixel
    crv2Pixel = float(win[1]) / h

    Pixels = []

    # The window plane is defiend as a set of three points (p0, p1, p2)
    p0 = np.array(posEye)
    p1 = p0+b
    p2 = p0+n
    p01 = p1 - p0 # segment
    p02 = p2 - p0 # segment

    for point in points:
        # ----------------------------------- #
        # COMPUTE pixel-position of point <p> #
        # ----------------------------------- #
        p = np.array(point)

        # Shall compute the intersection of the view of point <p> with the window plane

        # Such line is defined through two points (la, lb) as
        la, lb = np.array(posCam), p
        lab = lb - la # segment

        # Intersection is given by equation x = la + lab*t
        den = -lab.dot(np.cross(p01,p02))

        # Only for information (computation not required):
        # t = np.cross(p01,p02).dot(la-p0) / den
        # x = la + lab*t

        # parametric components (u, v) are actually what we look for
        u = np.cross(p02,-lab).dot(la-p0) / den
        v = np.cross(-lab,p01).dot(la-p0) / den

        # width and height in pixels are expressed in terms of (u, v)
        # Pixel components relative to Figure origin (upper left)
        pxP_w =  u*crv2Pixel + 0.5*float(win[0])
        pxP_h = -v*crv2Pixel + 0.5*float(win[1])

        Pixels += [[pxP_w, pxP_h]]
    return Pixels


def makeShaftRotate(t, iteration):
    '''
    For a turbomachinery case, make rotate all the domains depending on their `.Solver#Motion` node in 
    their family. The angle of rotation is computed as:
    :math:`\theta = t_0 + \Omega (i-i_0)`
    where :math:`t_0` corresponds to the `itime` elsA key, :math:`t_0` is the rotationnal speed of the 
    row (depending on the current zone), :math:`i` is the current iteration (input argument **iteration**)
    and :math:`i_0` corresponds to the `inititer` elsA key.

    Parameters
    ----------
    t : PyTree
        Should be the PyTree read from a ``surfaces_AfterIteration*.cgns``.

    iteration : int
        iteration of extraction of **t**. Should correspond to the iteration in the name 
        of the file ``surfaces_AfterIteration*.cgns``.
    '''
    # TODO: Is this iteration or iteration - 1 to consider ? 

    # TODO: rotate also BCDataSet, ZoneSubRegion, etc, and others vectors
    # typically what Maia already

    setup = J.load_source('setup', 'setup.py')

    ekn = setup.elsAkeysNumerics
    currentTime = ekn['itime'] + ekn['timestep'] * (iteration - ekn['inititer'])

    vectors2rotate = [['VelocityX', 'VelocityY', 'VelocityZ'], ['MomentumX', 'MomentumY', 'MomentumZ']]
    vectors = []
    for vec in vectors2rotate:
        vectors.append(vec)
        vectors.append(['centers:'+v for v in vec])

    for base in I.getBases(t):
        # Fill families information
        rowFrame = dict()
        for Family in I.getNodesFromType1(base, 'Family_t'):
            solverMotion = I.getNodeFromName(Family, '.Solver#Motion')
            if not solverMotion: 
                # Not a zone family or a zone family without movement
                continue
            solverMotionDict = dict((I.getName(node), I.getValue(node))
                                    for node in I.getNodesFromType(solverMotion, 'DataArray_t'))
            rowFrame[I.getName(Family)] = dict(
                omega =solverMotionDict['omega'],
                center=(solverMotionDict['axis_pnt_x'], solverMotionDict['axis_pnt_y'], solverMotionDict['axis_pnt_z']),
                axis  =(solverMotionDict['axis_vct_x'], solverMotionDict['axis_vct_y'], solverMotionDict['axis_vct_z'])   
            )
        for zone in I.getZones(base):
            familyNode = I.getNodeFromType1(zone, 'FamilyName_t')
            if not familyNode: continue
            row = I.getValue(familyNode)
            angleDeg = rowFrame[row]['omega'] * currentTime * 180/np.pi
            T._rotate(zone, rowFrame[row]['center'], 
                            rowFrame[row]['axis'], 
                            angleDeg, 
                            vectors=vectors)


def makeMovie(FRAMES_DIRECTORY='FRAMES', fps=24, width=400,
        resize_images=True, movie_filename='movie.avi', gif_filename=''):
    '''
    Make an gif animation easily from pre-existing frames (must be named 'frame*.png')

    Parameters
    ----------
    FRAMES_DIRECTORY : str, optional
        Directory where the frames are, by default 'FRAMES'
    filename : str, optional
        Name of the output file, by default 'animation.gif'
    fps : int, optional
        Number of frames per second, by default 24
    width : int, optional
        Width in pixels of the output animation file, by default 400
    '''

    # first, resize your images to the width size desired for final video 
    if resize_images:
        os.system(
            f'for img in {FRAMES_DIRECTORY}/frame*.png; do convert -resize {width} -quality 100 "$img" "{FRAMES_DIRECTORY}/resized-${{img##*/}}"; done')
            # f'for img in {FRAMES_DIRECTORY}/frame*.png; do echo ${{img##*/}}; done')
        resized_image_name='resized-frame'
    else:
        resized_image_name=''

    # second, create movie with (increase fps for having faster motion)
    if gif_filename and not movie_filename:
        movie_filename = gif_filename.replace('.gif','.avi')
    os.system(
        f'mencoder  mf://{FRAMES_DIRECTORY}/{resized_image_name}*.png -mf fps={fps}  -ovc x264 -x264encopts subq=6:partitions=all:8x8dct:me=umh:frameref=5:bframes=3:b_pyramid=normal:weight_b -o {movie_filename}')

    if gif_filename:
        # then convert movie to gif, by scaling to desired pixels (e.g. width 400 px)
        os.system(
            f'ffmpeg -i {movie_filename} -vf "fps=10,scale={width}:-1:flags=lanczos,split[s0][s1];[s0]palettegen[p];[s1][p]paletteuse" -loop 0 {gif_filename}')

def duplicateRows(t, setup=None, **RowsToDuplicate):
    '''
    Duplicate tree for visualization, for turbomachinery applications.

    Parameters
    ----------
    t : PyTree
        Input tree. It must be either a top tree or a base.

    setup : module, optional
        Read from ``setup.py``. If not given, the file ``setup.py`` is read in the current directory.

    RowsToDuplicate : kwargs
        Row families to duplicate. For each key, the value corresponds to the wished number of duplications.

    Examples
    --------

    .. code-block:: python

        import Converter.PyTree as C
        import MOLA.Visu as Visu 

        surfaces = C.convertFile2PyTree('OUTPUT/surfaces.cgns')
        Visu.duplicateRows(t, Rotor=3, Stator=5)

    Raises
    ------
    TypeError
        The input tree must be either a top tree or a base.
    '''

    import MOLA.WorkflowCompressor as WF

    if not setup:
        setup = J.load_source('setup', 'setup.py')

    if I.isTopTree(t) or I.getType(t) == 'CGNSBase_t':
        for row, nDupli in RowsToDuplicate.items():
            WF.duplicate(t, rowFamily=row, nBlades=setup.TurboConfiguration['Rows'][row]['NumberOfBlades'], 
                         nDupli=nDupli, verbose=1)
    else:
        raise TypeError('The input tree must be either a top tree or a base')


def prettyName(var):
    '''
    Return a pretty label to write on a plot axis.

    Parameters
    ----------
    var : str
        Name of the variable in the CGNS tree

    Returns
    -------
    str
        Depending on **var**, try to return a pretty name 'Variable [unit]'
    '''
    unit = None
    if any([v in var for v in ['MachNumber', 'Efficiency', 'Ratio', 'Coefficient', 'Loss']]):
        unit = '-'
    elif 'Pressure' in var:
        unit = 'Pa'
    elif 'Velocity' in var:
        unit = 'm/s'
    elif 'AngleDegree' in var:
        unit = 'deg'
    elif 'Enthalpy' in var:
        unit = r'J/kg'
    elif 'Entropy' in var:
        unit = r'J/kg/K'
    elif 'Efficiency' in var:
        unit = r'J.m$^3$/K/kg'
    elif 'Entropy' in var:
        unit = r'J.m$^3$/K/kg'
    remplacements = [
        ('StagnationPressureAbsDim', '$P_{t,abs}$'),
        ('StagnationTemperatureAbsDim', '$T_{t,abs}$'),
        ('StagnationEnthalpyAbsDim', '$h_{t,abs}$'),
        ('StagnationPressureRelDim', '$P_{t,rel}$'),
        ('StagnationTemperatureRelDim', '$T_{t,rel}$'),
        ('StagnationEnthalpyRelDim', '$h_{t,rel}$'),
        ('StaticPressureDim', '$P_s$'),
        ('StaticTemperatureDim', '$T_s$'),
        ('StaticEnthalpyDim', '$h_s$'),
        ('EntropyDim',  '$s$'),
        ('Viscosity_EddyMolecularRatio', '$\mu_t / \mu$'),
        ('VelocityMeridianDim',  '$V_m$'),
        ('VelocityThetaRelDim',  '$W_\\theta$'),
        ('VelocityThetaAbsDim', '$V_\\theta$'),
        ('MachNumberRel',  '$M_{rel}$'),
        ('MachNumberAbs', '$M_{abs}$'),
        ('IsentropicMachNumber', '$M_{is}$'),
        ('AlphaAngleDegree', r'$\alpha$'),
        ('BetaAngleDegree', r'$\beta$'),
        ('PhiAngleDegree', r'$\phi$'),
        ('ChannelHeight', 'h'),
        ('StagnationPressureRatio', '$P_{t, abs, 2}/P_{t, abs, 1}$'),
        ('StagnationTemperatureRatio', '$T_{t, abs, 2}/T_{t, abs, 1}$'),
        ('StaticPressureRatio', '$P_{s, 2}/P_{s, 1}$'),
        ('Static2StagnationPressureRatio', '$P_{s, 2}/P_{t, abs, 1}$'),
        ('IsentropicEfficiency', r'$\eta_{is}$'),
        ('PolytropicEfficiency',  r'$\eta_{pol}$'),
        ('StagnationEnthalpyDelta', r'$\Delta h_{t, abs}$'),
        ('StaticPressureCoefficient', '$c_p$'),
        ('StagnationPressureCoefficient', '$c_{P_t}$'),
        ('StagnationPressureLoss1', r'$\omega_{P_t}$'),
        ('StagnationPressureLoss2', r'$\tilde{\omega}_{P_t}$'),
    ]
    for LongName, ShortName in remplacements:
        var = var.replace(LongName, ShortName)
    if unit:
        var += ' ({})'.format(unit)
    return var


def getRadialProfiles(surfaces='OUTPUT/surfaces.cgns'):
    '''
    Get the radial profiles into a dictionary. This function may feed :py:func:`getRadialProfiles`. 

    Parameters
    ----------
    surfaces : str or PyTree
        name of the CGNS file with a 'RadialProfiles' node (default is 'OUTPUT/surfaces.cgns'),
        or already read PyTree. 

    Returns
    -------
        RadialProfiles : dict
            Dictionary with all radial profiles in **surfaces**. The structure is 
            the following:

            .. code-block:: python
            
                RadialProfiles['Iso_X_0.1'] = {'MachNumberAbs': numpy.array(...), 
                                               'EntropyDim': numpy.array(...), 
                                               ...
                                               '.ExtractionInfo': {...},
                                               '.PlotParameters': {...}
                                            }
            
            Each iso-surface has an arbitrary number of quantities, plus additional optional 
            data with a key name starting with a dot '.':

                * '.ExtractionInfo': it is fill automatically if the corresponding node is found.
                
                * '.PlotParameters': the function lets it empty, but you may fill this node with
                  parameters used in the 'plot' function of matplotlib if you give the returned
                  **RadialProfiles** to :py:func:`getRadialProfiles`.
    '''

    if isinstance(surfaces, str):
        surfaces = C.convertFile2PyTree(surfaces)

    RadialProfiles = dict()
    RadialProfilesBase = I.getNodeFromName1(surfaces, 'RadialProfiles')
    for zone in I.getZones(RadialProfilesBase):
        surfaceName = I.getName(zone)
        RadialProfiles[surfaceName] = J.getVars2Dict(zone, Container='FlowSolution#InitV')
        extractionInfo = J.get(zone, '.ExtractionInfo')
        if extractionInfo:
            RadialProfiles[surfaceName]['.ExtractionInfo'] = extractionInfo
        
        for FS in I.getNodesFromNameAndType(zone, 'Comparison#*', 'FlowSolution_t'):
            comparedPlane = I.getName(FS).split('#')[1]
            comparisonName = f'{surfaceName}#{comparedPlane}'
            RadialProfiles[comparisonName] = J.getVars2Dict(zone, Container=I.getName(FS))

    return RadialProfiles


def sortRadialProfiles(RadialProfiles):
    '''
    Sort radial profiles in two groups: 

    #. radial profiles on a single surface

    #. radial profiles resulting of the comparison of two surfaces (difference, quotient). For instance, 
       an isentropic efficiency profile.

    Parameters
    ----------
    RadialProfiles : dict
        as got from :py:func:`getRadialProfiles`

    Returns
    -------
    RadialProfilesSingleSurface, RadialProfilesComparison : :py:class:`tuple` of :py:class:`dict`
    '''

    RadialProfilesSingleSurface = dict()
    RadialProfilesComparison = dict()
    for surface, RadialProfilesOnSurface in RadialProfiles.items():
        if '#' in surface:
            RadialProfilesComparison[surface] = RadialProfilesOnSurface
        else:
            RadialProfilesSingleSurface[surface] = RadialProfilesOnSurface
    return RadialProfilesSingleSurface, RadialProfilesComparison

def plotRadialProfiles(RadialProfiles, filename='RadialProfiles.pdf', assemble=False, variablesToPlot=None):
    '''
    Plot radial profiles

    Parameters
    ----------
    RadialProfiles : dict
        as got from :py:func:`getRadialProfiles`.

        .. code-block:: python
            
                RadialProfiles['Iso_X_0.1'] = {'MachNumberAbs': numpy.array(...), 
                                               'EntropyDim': numpy.array(...), 
                                               ...
                                               '.ExtractionInfo': {...},
                                               '.PlotParameters': {...}
                                            }
            
        Each iso-surface has an arbitrary number of quantities, plus additional optional 
        data with a key name starting with a dot '.':

            * '.ExtractionInfo': information taken from a `.ExtractionInfo` node.
            
            * '.PlotParameters': additional parameters to be given to `matplotlib.pyplot.plot` function.
              '.PlotParameters' must be a :py:class:`dict`, it will be given as 'kwargs'.

        For each kind of variable, there may be a '.AxisProperty' argument that will be given to 
        the matplotlib axis object. For example, to set the limits of IsentropicEfficiency to 
        [0.7, 1.0], it must be set as:

        .. code-block:: python
            
                RadialProfiles['.AxisProperties']['IsentropicEfficiency'] = dict(xlim=[0.7, 1.0])
        
    filename : str, optional
        generic name of the file, by default 'RadialProfiles.pdf'

    assemble : bool, optional
        if True, write a unique PDF file with all the plots. By default False
    
    variablesToPlot : list
        Among the available data, plot only variables in this list. If :py:obj:`None`, plot all available data.

    '''
    
    try:
        os.makedirs(os.path.dirname(filename))
    except:
        pass

    filename_split = filename.split('.')
    filename_root = '.'.join(filename_split[:-1])
    extension = filename_split[-1]
    if not extension == 'pdf':
        assemble = False

    def getTextForFirstPage(RadialProfiles):
        '''Generate the text to fill the first page of the PDF file, with information on planes

        Parameters
        ----------
        RadialProfiles : dict
            as got from :py:func:`getRadialProfiles`

        Returns
        -------
        str
            text to write on the first page of the PDF file
        '''
        # First pages with infomation
        txt = 'RADIAL PROFILES\n\n'
        for plane, RadialProfilesOnPlane in RadialProfiles.items():
            ExtractionInfo = RadialProfilesOnPlane.get('.ExtractionInfo', {})
            PlotParameters = RadialProfilesOnPlane.get('.PlotParameters', dict(label=plane))
            if 'label' in PlotParameters:
                txt += PlotParameters['label'] + '\n'
            if ExtractionInfo:
                txt += f"IsoSurface {ExtractionInfo['field']} = {ExtractionInfo['value']}\n"
                try:
                    txt += f"{ExtractionInfo['ReferenceRow']} {ExtractionInfo['tag']}\n"
                except: 
                    pass
            txt += '\n'
        return txt

    if not assemble:

        for plane, RadialProfilesOnPlane in RadialProfiles.items():
            if plane.startswith('.'):
                continue
            variables2plot = []
            for var in RadialProfilesOnPlane:
                if not var in ['ChannelHeight', 'Gamma'] and not var.startswith('.'):
                    if (variablesToPlot is None) or (var in variablesToPlot):
                        variables2plot.append(var)
            
            PlotParameters = RadialProfilesOnPlane.get('.PlotParameters', dict(label=plane))

            for var in variables2plot:
                print(f'  > plot {var}')
                plt.figure()
                plt.plot(RadialProfilesOnPlane[var], RadialProfilesOnPlane['ChannelHeight'] * 100., **PlotParameters)
                plt.xlabel(prettyName(var))
                plt.ylabel('h (%)')
                plt.grid()
                plt.savefig(f'{filename_root}_{var}_{plane}.{extension}')
                plt.close()

    else:

        with PdfPages(filename) as pdf:

            textFirstPage = getTextForFirstPage(RadialProfiles)
            
            firstPage = plt.figure()
            firstPage.clf()
            firstPage.text(0.5, 0.5, textFirstPage, transform=firstPage.transFigure, size=12, ha="center", va="center")
            pdf.savefig()
            plt.close()

            # Assumption: same data on all plane
            variables2plot = []
            firstPlaneData = next(iter(RadialProfiles.values())) 
            for var in firstPlaneData:
                if not var in ['ChannelHeight', 'Gamma'] and not var.startswith('.'):
                    if (variablesToPlot is None) or (var in variablesToPlot):
                        variables2plot.append(var)
            
            AxisProperties = RadialProfiles.get('.AxisProperties', dict())

            for var in variables2plot:
                print(f'  > plot {var}')
                plt.figure()
                for plane, RadialProfilesOnPlane in RadialProfiles.items():
                    if plane.startswith('.'): 
                        continue
                    PlotParameters = RadialProfilesOnPlane.get('.PlotParameters', dict(label=plane))
                    if not var in RadialProfilesOnPlane: 
                        print(J.WARN + f'    not found on {plane}' + J.ENDC)
                        continue
                    plt.plot(RadialProfilesOnPlane[var], RadialProfilesOnPlane['ChannelHeight'] * 100., **PlotParameters)
                plt.xlabel(prettyName(var))
                plt.ylabel('h (%)')
                plt.grid()
                if len(RadialProfiles) > 1: 
                    plt.legend()
                if var in AxisProperties:
                    plt.gca().set(**AxisProperties[var])
                pdf.savefig()  # saves the current figure into a pdf page
                plt.close()


def _getMax(t, field_name):
    actual = -np.inf
    for z in I.getZones(t):
        for fs in I.getNodesFromType1(z,'FlowSolution_t'):
            node = I.getNodeFromName(z, field_name)
            if not node or node[3] != 'DataArray_t': continue
            actual = np.maximum(actual, np.max(node[1]))
    return actual

def _getMin(t, field_name):
    actual = np.inf
    for z in I.getZones(t):
        for fs in I.getNodesFromType1(z,'FlowSolution_t'):
            node = I.getNodeFromName(z, field_name)
            if not node or node[3] != 'DataArray_t': continue
            actual = np.minimum(actual, np.min(node[1]))
    return actual

def _fieldExistsAtNodesOrCentersAtZone(z, field_name, vertex_container_name,
        centers_container_name):
    z = I.getZones(z)[0]
    for fsname in [vertex_container_name, centers_container_name]:
        fs = I.getNodeFromName1(z,fsname)
        if not fs: continue
        if fs[3] != 'FlowSolution_t':
            print(f'WARNING: unexpected node {z[0]}/{vertex_container_name} of type {fs[3]}')
            continue
        for field in fs[2]:
            if field[0] == field_name: return True
    return False

def _fieldExistsAtNodesOrCenters(t, field_name, vertex_container_name,
        centers_container_name):

    zone_ok = [_fieldExistsAtNodesOrCentersAtZone(z,field_name,
        vertex_container_name,
        centers_container_name) for z in I.getZones(t)]

    return all(zone_ok)
        